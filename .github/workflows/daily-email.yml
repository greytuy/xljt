# GitHub Action: æ¯æ—¥å¿ƒçµé¸¡æ±¤é‚®ä»¶

name: Daily Inspirational Email

on:
  #æ·»åŠ pushè§¦å‘
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨åœ¨ Actions æ ‡ç­¾é¡µè§¦å‘æ­¤å·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:
  # è®¾ç½®å®šæ—¶ä»»åŠ¡
  schedule:
    # cron è¡¨è¾¾å¼ä½¿ç”¨ UTC æ—¶é—´ã€‚'0 1 * * *' å¯¹åº” UTC æ—¶é—´çš„ 01:00ï¼Œ
    # å³åŒ—äº¬æ—¶é—´ (UTC+8) çš„æ—©ä¸Š 9:00ã€‚
    - cron: '0 1 * * *'

jobs:
  send-daily-email:
    # ä½¿ç”¨æœ€æ–°çš„ ubuntu è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      # ä½¿ç”¨ actions/checkout@v4 æ‹‰å–ä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      # ä½¿ç”¨ actions/setup-node@v4 æ¥æŒ‡å®š Node.js ç‰ˆæœ¬
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ä½¿ç”¨ Node.js 20.x ç‰ˆæœ¬
          cache: 'npm' # ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ å¿«åç»­æ„å»ºé€Ÿåº¦

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      # è¿è¡Œ npm ci ä¼šä¸¥æ ¼æŒ‰ç…§ package-lock.json å®‰è£…ä¾èµ–ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
      - name: Install dependencies
        run: npm ci

      # ç¬¬å››æ­¥ï¼šè¿è¡Œè„šæœ¬å‘é€é‚®ä»¶
      # å°† GitHub Secrets è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œå¹¶æ‰§è¡Œ Node.js è„šæœ¬
      - name: Run script to send email
        env:
          AI_CONFIG: ${{ secrets.AI_CONFIG }}
          MAIL_CONFIG: ${{ secrets.MAIL_CONFIG }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          DEBUG: 'false' # è®¾ç½®ä¸º 'true' å¯æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•æ„Ÿæ•°æ®
        run: node send-email.js

# ç¬¬äº”æ­¥ï¼šæ¸…ç†æ—§çš„ workflow è¿è¡Œï¼Œä»…ä¿ç•™æœ€æ–°ä¸€æ¬¡
      - name: ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
      # - name: Delete workflow runs
      #   uses: Mattraks/delete-workflow-runs@v2.0.6
